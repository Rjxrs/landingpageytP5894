<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graal Classic Pro</title>
    <!-- Tailwind CSS via CDN for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom base styles and scrollbar hiding */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000000; /* Optimized Pure Black */
            color: #e5e5e5;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Calculate remaining height for the iframe perfectly */
        .game-container {
            height: calc(100vh - 3.5rem); /* 3.5rem is h-14 */
        }

        /* Range slider custom styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #10b981; /* emerald-500 */
            cursor: pointer;
            margin-top: -5px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #262626; /* neutral-800 */
            border-radius: 2px;
        }

        /* Toast animation */
        .toast-enter {
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .toast-leave {
            animation: slideOut 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
    </style>
</head>
<body class="flex flex-col antialiased selection:bg-emerald-500 selection:text-white bg-black">

    <!-- Top Control Bar -->
    <header class="h-14 bg-neutral-950 border-b border-neutral-900 flex items-center justify-between px-4 sm:px-6 shrink-0 z-20 shadow-md relative">
        <!-- Logo / Title -->
        <div class="flex items-center gap-2 select-none">
            <div class="w-8 h-8 rounded-md bg-gradient-to-br from-neutral-800 to-neutral-900 border border-neutral-800 flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12L12 4L18 12M12 4V20"/></svg>
            </div>
            <h1 class="font-bold text-lg tracking-tight hidden sm:block text-white">Graal Classic <span class="text-neutral-500">PRO</span></h1>
        </div>

        <!-- Controls -->
        <div class="flex items-center gap-1 sm:gap-2">
            
            <!-- Settings Menu Toggle (Gear Icon) -->
            <button id="btn-settings" class="p-2 rounded-md text-neutral-400 hover:text-white hover:bg-neutral-900 transition-all focus:outline-none" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>

            <!-- Pop-out Window (Mini Player) -->
            <button id="btn-popout" class="p-2 rounded-md text-neutral-400 hover:text-white hover:bg-neutral-900 transition-all focus:outline-none" title="Mini Player Pop-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><rect x="11" y="11" width="8" height="8" rx="1" ry="1"></rect></svg>
            </button>

            <!-- Fullscreen -->
            <button id="btn-fullscreen" class="p-2 rounded-md text-neutral-400 hover:text-white hover:bg-neutral-900 transition-all focus:outline-none" title="Toggle Fullscreen">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            </button>
        </div>
    </header>

    <!-- Settings Dropdown -->
    <div id="settings-menu" class="hidden absolute top-16 right-4 w-64 bg-neutral-950 border border-neutral-800 rounded-lg shadow-2xl z-30 p-4 flex flex-col gap-5 text-sm">
        <div class="flex items-center justify-between">
            <span class="font-semibold text-white">Settings</span>
            <button id="btn-close-settings" class="text-neutral-500 hover:text-white focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        
        <!-- Input Mode Toggle -->
        <div class="flex flex-col gap-2">
            <span class="text-neutral-400">Input Method</span>
            <button id="btn-input-toggle" class="group flex items-center justify-center gap-2 w-full px-3 py-2.5 rounded-md bg-neutral-900 hover:bg-neutral-800 transition-colors border border-neutral-800 focus:outline-none">
                <svg id="icon-keyboard" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18v12H3z"/><path d="M7 10h.01"/><path d="M11 10h.01"/><path d="M15 10h.01"/><path d="M7 14h10"/></svg>
                <svg id="icon-gamepad" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-neutral-500 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/><path d="M9 12h.01"/><path d="M15 12h.01"/></svg>
                <span id="label-input" class="font-medium text-neutral-300">Keyboard</span>
            </button>
        </div>

        <!-- Volume Control -->
        <div class="flex flex-col gap-2">
            <span class="text-neutral-400">Master Volume</span>
            <div class="flex items-center gap-3 bg-neutral-900 px-3 py-2.5 rounded-md border border-neutral-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-neutral-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                <input type="range" id="volume-slider" min="0" max="100" value="100" class="w-full focus:outline-none">
            </div>
        </div>
    </div>

    <!-- Game Iframe Container -->
    <main class="game-container w-full relative flex items-center justify-center bg-black">
        <!-- Loader Background -->
        <div class="absolute inset-0 flex flex-col items-center justify-center z-0">
            <div class="w-10 h-10 border-4 border-neutral-800 border-t-emerald-500 rounded-full animate-spin"></div>
            <p class="mt-4 text-neutral-500 text-sm font-medium">Connecting to Graal...</p>
        </div>
        
        <!-- Iframe -->
        <iframe 
            id="game-frame" 
            src="https://classic.graalonline.com" 
            class="w-full h-full border-none z-10 relative bg-transparent"
            allow="gamepad *; autoplay; fullscreen"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads"
        ></iframe>
    </main>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-16 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2 pointer-events-none"></div>

    <!-- Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const frame = document.getElementById('game-frame');
            const btnFullscreen = document.getElementById('btn-fullscreen');
            const btnPopout = document.getElementById('btn-popout');
            const btnSettings = document.getElementById('btn-settings');
            const settingsMenu = document.getElementById('settings-menu');
            const btnCloseSettings = document.getElementById('btn-close-settings');
            const volumeSlider = document.getElementById('volume-slider');
            const btnInputToggle = document.getElementById('btn-input-toggle');
            const iconKeyboard = document.getElementById('icon-keyboard');
            const iconGamepad = document.getElementById('icon-gamepad');
            const labelInput = document.getElementById('label-input');
            const toastContainer = document.getElementById('toast-container');

            // --- State ---
            let inputMode = 'keyboard'; // 'keyboard' | 'gamepad'
            let gamepadPolling = null;
            let connectedGamepads = {};

            // --- 1. Fullscreen Toggle ---
            btnFullscreen.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        showToast(`Error: ${err.message}`, 'error');
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });

            // Update UI on fullscreen change
            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                btnFullscreen.innerHTML = isFullscreen 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>`;
            });

            // --- 2. Pop-out Window (Mini Player) ---
            btnPopout.addEventListener('click', () => {
                if (!frame) return;

                // Stop iframe here if popping out
                frame.src = 'about:blank'; 
                
                // YouTube mini-player style dimensions and placement
                const width = 640;
                const height = 480;
                const left = window.screen.width - width - 40; 
                const top = window.screen.height - height - 80;
                
                // Using popup=yes forces the most minimal browser window possible
                window.open(
                    'https://classic.graalonline.com',
                    'GraalMiniPlayer',
                    `width=${width},height=${height},top=${top},left=${left},popup=yes,toolbar=no,menubar=no,scrollbars=no,resizable=yes,location=no,status=no`
                );
                
                showToast('Mini player opened.', 'info');
                
                document.querySelector('.game-container').innerHTML = `
                    <div class="text-neutral-500 flex flex-col items-center justify-center h-full gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-neutral-800" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><rect x="11" y="11" width="8" height="8" rx="1" ry="1"></rect></svg>
                        <p>Playing in mini window</p>
                        <button onclick="location.reload()" class="px-5 py-2.5 bg-neutral-900 border border-neutral-800 text-white font-medium rounded-md hover:bg-neutral-800 transition shadow-lg">Return to Main View</button>
                    </div>
                `;
            });

            // --- 2.5 Settings Menu Logic ---
            const toggleSettings = () => {
                settingsMenu.classList.toggle('hidden');
            };

            btnSettings.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSettings();
            });

            btnCloseSettings.addEventListener('click', () => {
                settingsMenu.classList.add('hidden');
            });

            // Close settings when clicking outside
            document.addEventListener('click', (e) => {
                if (!settingsMenu.classList.contains('hidden') && !settingsMenu.contains(e.target) && e.target !== btnSettings) {
                    settingsMenu.classList.add('hidden');
                }
            });

            // --- 3. Volume Control ---
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value;
                const message = {
                    type: 'SET_VOLUME',
                    volume: vol / 100
                };

                if(frame && frame.contentWindow) {
                    frame.contentWindow.postMessage(message, 'https://classic.graalonline.com');
                }
            });

            // --- 4. Input Toggle ---
            btnInputToggle.addEventListener('click', () => {
                if (inputMode === 'keyboard') {
                    setInputMode('gamepad');
                } else {
                    setInputMode('keyboard');
                }
            });

            function setInputMode(mode) {
                inputMode = mode;
                if (mode === 'gamepad') {
                    iconKeyboard.classList.add('hidden');
                    iconKeyboard.classList.remove('text-emerald-500');
                    iconGamepad.classList.remove('hidden');
                    iconGamepad.classList.add('text-emerald-500');
                    labelInput.textContent = 'Controller';
                    labelInput.classList.replace('text-neutral-300', 'text-emerald-500');
                    showToast('Gamepad mode activated.', 'success');
                } else {
                    iconGamepad.classList.add('hidden');
                    iconGamepad.classList.remove('text-emerald-500');
                    iconKeyboard.classList.remove('hidden');
                    iconKeyboard.classList.add('text-emerald-500');
                    labelInput.textContent = 'Keyboard';
                    labelInput.classList.replace('text-emerald-500', 'text-neutral-300');
                }
                
                if (frame) frame.focus();
            }

            // --- 5. Gamepad API Integration ---
            window.addEventListener("gamepadconnected", (e) => {
                connectedGamepads[e.gamepad.index] = e.gamepad;
                showToast(`Controller Connected`, 'success');
                setInputMode('gamepad');
                startGamepadLoop();
            });

            window.addEventListener("gamepaddisconnected", (e) => {
                delete connectedGamepads[e.gamepad.index];
                showToast('Controller Disconnected.', 'error');
                if (Object.keys(connectedGamepads).length === 0) {
                    setInputMode('keyboard');
                    stopGamepadLoop();
                }
            });

            function startGamepadLoop() {
                if (gamepadPolling) return;
                const previousState = {};

                function loop() {
                    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                    for (let i = 0; i < gamepads.length; i++) {
                        const gp = gamepads[i];
                        if (!gp) continue;
                        if (!previousState[i]) previousState[i] = { buttons: [] };
                        gp.buttons.forEach((button, btnIndex) => {
                            const isPressed = button.pressed || button.value > 0.5;
                            const wasPressed = previousState[i].buttons[btnIndex];
                            if (isPressed && !wasPressed) {
                                handleGamepadInput(gp.index, 'button_down', btnIndex);
                            } else if (!isPressed && wasPressed) {
                                handleGamepadInput(gp.index, 'button_up', btnIndex);
                            }
                            previousState[i].buttons[btnIndex] = isPressed;
                        });
                    }
                    gamepadPolling = requestAnimationFrame(loop);
                }
                loop();
            }

            function stopGamepadLoop() {
                if (gamepadPolling) {
                    cancelAnimationFrame(gamepadPolling);
                    gamepadPolling = null;
                }
            }

            function handleGamepadInput(controllerId, eventType, inputId) {
                if(inputMode !== 'gamepad') return;
                const message = {
                    type: 'GAMEPAD_INPUT',
                    controllerId: controllerId,
                    eventType: eventType,
                    inputId: inputId
                };
                if(frame && frame.contentWindow) {
                    frame.contentWindow.postMessage(message, 'https://classic.graalonline.com');
                }
            }

            // --- Utility: Toast Notifications ---
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast-enter flex items-center gap-2 px-4 py-2 rounded-md shadow-lg text-sm font-medium border text-white ${
                    type === 'success' ? 'bg-emerald-600/90 border-emerald-500' : 
                    type === 'error' ? 'bg-rose-600/90 border-rose-500' : 
                    'bg-neutral-800/90 border-neutral-700'
                }`;
                toast.innerHTML = `<span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.replace('toast-enter', 'toast-leave');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            }

            // --- Initialization ---
            const container = document.querySelector('.game-container');
            if (container) {
                container.addEventListener('click', () => {
                    if (frame) frame.focus();
                });
            }
            
            setTimeout(() => {
                if (frame) frame.focus();
            }, 1000);
        });
    </script>
</body>
</html>
