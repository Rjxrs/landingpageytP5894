<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 3D Audio Visualizer (Theme Switch)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <style>
        /* Define base (light mode) variables/styles */
        body {
            /* Default light mode styles */
            margin: 0;
            overflow: hidden;
            background-color: #f8f9fa; /* Light background */
            color: #212529; /* Dark text */
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Dark mode styles */
        .dark body {
            background-color: #000;
            color: #fff;
        }

        #visualizer-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }

        /* Top Bar Styling */
        #top-bar-new {
            /* Base (light) styles */
            background-color: rgba(255, 255, 255, 0.8); /* Light semi-transparent */
            border-bottom-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
        }
        /* Dark mode styles for top bar */
        .dark #top-bar-new {
            background-color: rgba(0, 0, 0, 0.8); /* Dark semi-transparent */
            border-bottom-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }
        #time-date-display {
             color: #6b7280; /* gray-500 */
        }
        .dark #time-date-display {
             color: #9ca3af; /* gray-400 */
        }

        /* Top Bar Buttons Base Style */
        .top-bar-btn {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            width: 2rem; height: 2rem; border-radius: 9999px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .top-bar-btn:hover {
            background-color: #d1d5db; /* gray-300 */
            color: #1f2937; /* gray-800 */
            transform: scale(1.05);
        }
        /* Dark mode styles for top bar buttons */
        .dark .top-bar-btn {
            background-color: #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
        }
        .dark .top-bar-btn:hover {
            background-color: #6b7280; /* gray-500 */
            color: #ffffff; /* white */
        }

        /* Controls Container Styling */
        .controls-container {
            /* Base (light) styles */
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            color: #1f2937; /* Dark text */
            border: 1px solid #e5e7eb; /* Light border */
            /* Other styles remain */
            padding: 25px; border-radius: 16px; margin-top: 20px; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: stretch; gap: 20px;
            z-index: 10; max-width: 95%; width: 600px; max-height: calc(90vh - 80px);
            overflow-y: auto; position: relative;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* Dark mode styles for controls container */
        .dark .controls-container {
            background-color: rgba(25, 25, 25, 0.85);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            color: #e5e7eb; /* Light text */
            border: 1px solid #4b5563; /* Dark border */
        }

        /* Section titles */
        .section-title {
            font-size: 1.1rem; font-weight: 600; color: #374151; /* Darker text */
            margin-bottom: 8px; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .dark .section-title {
            color: #f3f4f6; /* Lighter text */
            border-bottom-color: #4b5563; /* Darker border */
        }

        /* General input/button styling */
        label, button, select { font-size: 0.95rem; transition: color 0.3s ease; }
        input[type="color"], input[type="range"], select, button, label[for="audio-file-input"] {
            padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; /* Light border */
            background-color: #f3f4f6; /* Lighter background */
            color: #1f2937; /* Dark text */
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        /* Dark mode inputs/buttons */
        .dark input[type="color"], .dark input[type="range"], .dark select, .dark button, .dark label[for="audio-file-input"] {
             border-color: #4b5563; /* Darker border */
             background-color: #374151; /* Darker background */
             color: #f3f4f6; /* Lighter text */
        }

        input[type="range"] { padding: 0; cursor: grab; }
        input[type="color"] { min-height: 38px; padding: 4px; background-color: #fff; } /* Keep color picker bg white */
        .dark input[type="color"] { background-color: #e5e7eb; } /* Slightly off-white for dark mode picker */

        /* Button Hover States */
        button:hover, label[for="audio-file-input"]:hover, select:hover { background-color: #e5e7eb; border-color: #9ca3af; }
        .dark button:hover, .dark label[for="audio-file-input"]:hover, .dark select:hover { background-color: #4b5563; border-color: #6b7280; }

        /* Specific Buttons */
        label[for="audio-file-input"] { background-color: #3b82f6; color: white; border-color: #3b82f6; } /* blue-500 */
        label[for="audio-file-input"]:hover { background-color: #2563eb; border-color: #2563eb; } /* blue-600 */
        .dark label[for="audio-file-input"] { background-color: #3b82f6; border-color: #3b82f6; }
        .dark label[for="audio-file-input"]:hover { background-color: #2563eb; border-color: #2563eb; }

        #play-builtin-btn { background-color: #8b5cf6; color: white; border-color: #8b5cf6; } /* violet-500 */
        #play-builtin-btn:hover { background-color: #7c3aed; border-color: #7c3aed; } /* violet-600 */
        .dark #play-builtin-btn { background-color: #8b5cf6; border-color: #8b5cf6; }
        .dark #play-builtin-btn:hover { background-color: #7c3aed; border-color: #7c3aed; }

        #play-radio-btn { background-color: #10b981; color: white; border-color: #10b981; } /* emerald-500 */
        #play-radio-btn:hover { background-color: #059669; border-color: #059669; } /* emerald-600 */
        .dark #play-radio-btn { background-color: #10b981; border-color: #10b981; }
        .dark #play-radio-btn:hover { background-color: #059669; border-color: #059669; }

        #bg-change-btn { background-color: #6b7280; color: white; border-color: #6b7280; } /* gray-500 */
        #bg-change-btn:hover { background-color: #4b5563; border-color: #4b5563; } /* gray-600 */
        .dark #bg-change-btn { background-color: #6b7280; border-color: #6b7280; }
        .dark #bg-change-btn:hover { background-color: #4b5563; border-color: #4b5563; }


        #audio-file-input { display: none; }
        audio { width: 100%; filter: brightness(0.8) contrast(1.2) saturate(0.8); border-radius: 8px; margin-top: 5px; } /* Adjusted filter for light/dark */
        .dark audio { filter: invert(1) sepia(0.5) saturate(5) hue-rotate(180deg) brightness(0.9); } /* Keep dark mode filter */

        .info-text, #loading-message { font-size: 0.85rem; color: #6b7280; text-align: center; margin-top: 5px; transition: color 0.3s ease; }
        .dark .info-text, .dark #loading-message { color: #9ca3af; }
        #loading-message { font-style: italic; }

        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-group label { flex-shrink: 0; width: 100px; }
        .control-group input, .control-group select, .control-group span { flex-grow: 1; }
        .control-group span { text-align: right; min-width: 40px; }
        .control-group input[type="checkbox"] { flex-grow: 0; width: auto; margin-right: 5px; }
        optgroup { font-weight: bold; font-style: italic; color: #4b5563; background-color: #e5e7eb; }
        .dark optgroup { color: #9ca3af; background-color: #374151; }
        option { background-color: #f9fafb; color: #1f2937; }
        .dark option { background-color: #4b5563; color: #f3f4f6; }

    </style>
</head>
<body>
    <div id="top-bar-new" class="flex justify-between items-center w-full px-4 py-2 sticky top-0 z-20 border-b backdrop-blur-sm">
        <div id="time-date-display" class="text-sm whitespace-nowrap">Loading...</div>

        <div class="flex items-center space-x-3"> <a href="https://rjxrs.github.io/landingpageytP5894/" class="top-bar-btn" title="Home">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
             </a>
            <a href="https://rjxrs.github.io/landingpageytP5894/mp3%20player.html" class="top-bar-btn" target="_blank" rel="noopener noreferrer" title="MP3 Player">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v1a3 3 0 0 0 3 3v0a3 3 0 0 0 3-3v-1"></path><path d="M12 11v10"></path><path d="M8 17a4 4 0 1 0 8 0"></path><path d="M18 10v1a3 3 0 0 1 3 3v0a3 3 0 0 1-3-3v-1"></path></svg>
             </a>
            <button id="theme-toggle-btn" class="top-bar-btn" title="Toggle Theme">
                <span id="theme-icon-placeholder"></span>
            </button>
        </div>
    </div>

    <div class="controls-container rounded-lg shadow-lg">
        <div>
             <p class="section-title">Select Audio Source</p>
             <label for="audio-file-input" class="w-full mb-2">Choose Local Audio File</label>
             <input type="file" id="audio-file-input" accept="audio/*, .m4a">
             <button id="play-builtin-btn" class="w-full mb-2">Play Built-in Track: Lock In</button>
             <div class="control-group mb-1">
                 <select id="radio-select" class="w-full">
                     <option value="">-- Or Select Radio Station --</option>
                     <optgroup label="United Kingdom">
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_radio1_mf_p">BBC Radio 1 (MP3)</option>
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_radio2_mf_p">BBC Radio 2 (MP3)</option>
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_6music_mf_p">BBC Radio 6 Music (MP3)</option>
                         <option value="https://media-ssl.musicradio.com/CapitalUK">Capital UK (AAC)</option>
                         <option value="https://media-ssl.musicradio.com/HeartUK">Heart UK (AAC)</option>
                     </optgroup>
                     <optgroup label="Germany">
                         <option value="http://st01.dlf.de/dlf/01/128/mp3/stream.mp3">Deutschlandfunk (MP3)</option>
                         <option value="https://br-edge-2051-fra-ts-cdn.cast.addradio.de/br/br3/live/mp3/128/stream.mp3">Bayern 3 (MP3)</option>
                         <option value="http://stream.1a-webradio.de/deutsch/mp3">1A Deutsche Hits (MP3)</option>
                          <option value="https://streams.planetradio.de/planetradio/mp3/hqlivestream.mp3">Planet Radio (MP3)</option>
                     </optgroup>
                     <optgroup label="France">
                         <option value="https://icecast.radiofrance.fr/franceinter-hifi.aac">France Inter (AAC)</option>
                         <option value="https://icecast.radiofrance.fr/fip-hifi.aac">FIP (AAC)</option>
                         <option value="http://cdn.nrjaudio.fm/audio1/fr/30001/mp3_128.mp3">NRJ France (MP3)</option>
                          <option value="http://streaming.radio.rtl.fr/rtl-1-44-128">RTL France (MP3)</option>
                     </optgroup>
                     <optgroup label="Netherlands">
                          <option value="https://icecast.omroep.nl/radio1-bb-mp3">NPO Radio 1 (MP3)</option>
                          <option value="https://icecast.omroep.nl/radio2-bb-mp3">NPO Radio 2 (MP3)</option>
                          <option value="https://icecast.omroep.nl/3fm-bb-mp3">NPO 3FM (MP3)</option>
                          <option value="http://playerservices.streamtheworld.com/api/livestream-redirect/RADIO538AAC.aac">Radio 538 (AAC)</option>
                          <option value="http://stream.qmusic.nl/qmusic/aacp">Qmusic NL (AAC+)</option>
                      </optgroup>
                     <optgroup label="Spain">
                         <option value="http://haydn.torontocast.com:2199/stream/los40principales_alternative_es">Los40 Principales (MP3 - Alt Source)</option>
                         <option value="http://cadena100-cope-rrcast.flumotion.com/cope/cadena100-low.mp3">Cadena 100 (MP3)</option>
                         <option value="http://rne.rtveradio.cires21.com/rne_r3.mp3">RNE Radio 3 (MP3)</option>
                     </optgroup>
                     <optgroup label="Italy">
                         <option value="https://icstream.rds.radio/rds">RDS (AAC)</option>
                         <option value="http://icecast.rtl.it/RTL1025.mp3">RTL 102.5 (MP3)</option>
                         <option value="http://ice01.fluidstream.net/fluid011.aac">Radio Deejay (AAC)</option>
                     </optgroup>
                      <optgroup label="Other/Internet">
                          <option value="https://somafm.com/defcon.pls">SomaFM DEF CON Radio (PLS)</option>
                          <option value="https://somafm.com/groovesalad.pls">SomaFM Groove Salad (PLS)</option>
                          <option value="https://stream.radioparadise.com/aac-192">Radio Paradise Main (AAC 192k)</option>
                          <option value="http://stream-dc4.radioparadise.com/mellow-320">Radio Paradise Mellow Mix (MP3 320k)</option>
                      </optgroup>
                 </select>
                 <button id="play-radio-btn" class="px-3 py-1 rounded flex-shrink-0">Play</button>
             </div>
             <p id="loading-message" class="info-text">Select a source above.</p>
             <p class="info-text">Tip: Use standard MP3, AAC(.m4a), WAV, or Ogg files for best compatibility.</p>
             <p class="info-text">Radio streams depend on external sources & CORS. Availability may vary.</p>
        </div>

         <div>
             <p class="section-title">Audio Player</p>
             <audio id="audio-source" controls crossorigin="anonymous" class="w-full rounded"></audio>
         </div>

        <div>
            <p class="section-title">Playback Controls</p>
            <div class="control-group">
                <label for="speed-slider">Speed:</label>
                <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0" class="flex-grow">
                <span id="speed-value">1.0x</span>
            </div>
            <div class="control-group mt-2">
                 <label for="loop-checkbox" class="w-auto">Loop:</label> <input type="checkbox" id="loop-checkbox">
                 <span class="flex-grow info-text text-left pl-2">(For local files/built-in)</span> </div>
             <p class="info-text mt-2">Quality depends on the source file/stream.</p>
        </div>

        <div>
            <p class="section-title">Visualizer Options</p>
            <div class="control-group">
                <label for="bar-color-picker">Bar Color:</label>
                <input type="color" id="bar-color-picker" value="#00ffcc"> </div>
             <div class="control-group mt-2">
                 <label for="bg-change-btn">Background:</label>
                 <button id="bg-change-btn" class="flex-grow">Cycle Background</button>
             </div>
             <p class="info-text mt-2">Use mouse/touch to rotate/zoom the visualizer.</p>
        </div>
    </div>

    <canvas id="visualizer-canvas"></canvas>

    <script>
        // --- Global Variables ---
        let scene, camera, renderer, controls, composer;
        let audioContext, analyser, source, dataArray, bufferLength;
        const bars = [];
        const NUM_BARS = 128;
        let isAudioContextInitialized = false;
        let currentObjectURL = null;
        let baseBarColor = new THREE.Color(0x00ffcc);
        const backgroundColors = [0x000000, 0x1a1a2a, 0x2a1a1a, 0x1a2a1a, 0x2a2a4a]; // Keep dark backgrounds for visualizer
        let currentBgIndex = 0; // Index for visualizer background cycle
        const BUILTIN_TRACK_URL = "https://rjxrs.github.io/landingpageytP5894/lock-in.mp3";
        const BUILTIN_TRACK_NAME = "Lock In";
        let timeDateInterval;

        // --- SVG Icons ---
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>`;

        // --- Initialization ---
        function init() {
            // --- Basic Scene Setup ---
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 60);
            const canvas = document.getElementById('visualizer-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // Keep visualizer background dark, cycle through dark variants
            renderer.setClearColor(backgroundColors[currentBgIndex], 1);
            renderer.setPixelRatio(window.devicePixelRatio);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.dampingFactor = 0.05;
            controls.minDistance = 10; controls.maxDistance = 250; controls.target.set(0, 0, 0);

            // --- Visualizer Cylinders ---
            const barRadius = 0.3, spacing = 0.3;
            const totalWidth = (barRadius * 2 + spacing) * NUM_BARS;
            const startX = -totalWidth / 2 + barRadius;
            const geometry = new THREE.CylinderGeometry(barRadius, barRadius, 1, 16);
            const material = new THREE.MeshPhongMaterial({
                 color: baseBarColor.clone(), emissive: baseBarColor.clone().multiplyScalar(0.3),
                 specular: 0x222222, shininess: 60, side: THREE.DoubleSide });
            for (let i = 0; i < NUM_BARS; i++) {
                const barMaterial = material.clone();
                const bar = new THREE.Mesh(geometry, barMaterial);
                bar.position.x = startX + i * (barRadius * 2 + spacing);
                bar.scale.y = 0.1;
                scene.add(bar); bars.push(bar);
            }

            // --- Lighting ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xaaaaff, 0.8, 500); pointLight.position.set(0, 50, 60); scene.add(pointLight);
            const pointLight2 = new THREE.PointLight(0xffaaaa, 0.5, 500); pointLight2.position.set(-60, 30, 40); scene.add(pointLight2);

            // --- Post Processing (Bloom) ---
            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene); composer.addPass(bloomPass);

            // --- Initialize Theme ---
            const currentTheme = getPreferredTheme();
            applyTheme(currentTheme);

            // --- Start Live Time/Date Update ---
            startTimeDateUpdate();

            // --- Event Listeners & Start ---
            setupEventListeners();
            animate();
            window.addEventListener('resize', onWindowResize, false);
            console.log("Visualizer Initialized with Theme Switch, New Top Bar & Bloom Effect");
        }

        // --- Theme Handling ---
        function applyTheme(theme) {
            const htmlElement = document.documentElement;
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const iconPlaceholder = document.getElementById('theme-icon-placeholder');

            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                if (iconPlaceholder) iconPlaceholder.innerHTML = sunIcon; // Show sun icon to switch to light
                if (themeToggleBtn) themeToggleBtn.setAttribute('title', 'Switch to Light Mode');
            } else {
                htmlElement.classList.remove('dark');
                if (iconPlaceholder) iconPlaceholder.innerHTML = moonIcon; // Show moon icon to switch to dark
                if (themeToggleBtn) themeToggleBtn.setAttribute('title', 'Switch to Dark Mode');
            }
            // Note: Visualizer background cycle remains independent of light/dark theme
        }

        function getPreferredTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                return storedTheme;
            }
            // Default to dark theme if no preference or system preference
            // return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
             return 'dark'; // Defaulting to dark for this app's aesthetic
        }

        function handleThemeToggle() {
            const htmlElement = document.documentElement;
            const currentIsDark = htmlElement.classList.contains('dark');
            const newTheme = currentIsDark ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }


        // --- Live Time and Date Update ---
         const updateTimeDate = () => { /* ... same as previous ... */
             const timeDateDisplay = document.getElementById('time-date-display');
             if (timeDateDisplay) {
                 const now = new Date();
                 const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                 const optionsTime = { hour: 'numeric', minute: '2-digit' };
                 try {
                    const formattedDate = now.toLocaleDateString(undefined, optionsDate);
                    const formattedTime = now.toLocaleTimeString(undefined, optionsTime);
                    timeDateDisplay.textContent = `${formattedDate} | ${formattedTime}`;
                 } catch (e) {
                    console.error("Error formatting date/time:", e);
                    timeDateDisplay.textContent = now.toDateString() + " " + now.toTimeString().substring(0,5);
                 }
             }
         };
         function startTimeDateUpdate() { /* ... same as previous ... */
             updateTimeDate();
             if(timeDateInterval) clearInterval(timeDateInterval);
             timeDateInterval = setInterval(updateTimeDate, 1000 * 30);
         }


        // --- Web Audio API Setup ---
        // (Function remains the same as previous version)
        function setupAudioContextAndSource(audioElement) { /* ... same as previous ... */
            console.log("Attempting to setup AudioContext. Initialized:", isAudioContextInitialized);
            if (isAudioContextInitialized) {
                 if (!source || source.mediaElement !== audioElement) {
                     console.log("AudioContext exists, reconnecting source...");
                     if (source) { try { source.disconnect(); } catch (e) { console.warn("Error disconnecting previous source:", e); } }
                     try {
                        source = audioContext.createMediaElementSource(audioElement);
                        source.connect(analyser);
                        console.log("Reconnected source to analyser");
                     } catch(e) {
                         console.error("Error reconnecting source:", e);
                         isAudioContextInitialized = false;
                         document.getElementById('loading-message').textContent = "Error connecting audio source.";
                         return;
                     }
                 } else { console.log("AudioContext exists, source seems connected."); }
                 resumeAudioContext();
                 return;
            }
            try {
                console.log("Creating new AudioContext and Analyser...");
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = NUM_BARS * 2;
                analyser.minDecibels = -90;
                analyser.maxDecibels = -10;
                analyser.smoothingTimeConstant = 0.85;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                source = audioContext.createMediaElementSource(audioElement);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                isAudioContextInitialized = true;
                console.log("AudioContext Initialized and Source Connected Successfully.");
                audioElement.addEventListener('play', resumeAudioContext);
                document.body.addEventListener('click', resumeAudioContext, { once: true });
            } catch (e) {
                console.error("Fatal Error setting up Web Audio API:", e);
                document.getElementById('loading-message').textContent = "Fatal Error initializing audio.";
                alert("Web Audio API setup failed: " + e.message + ". Please refresh or try a different browser.");
                isAudioContextInitialized = false;
            }
         }
        function resumeAudioContext() { /* ... same as previous ... */
             if (audioContext && audioContext.state === 'suspended') {
                 console.log("AudioContext is suspended, attempting to resume...");
                 audioContext.resume().then(() => {
                     console.log("AudioContext Resumed successfully.");
                 }).catch(e => console.error("Error resuming AudioContext:", e));
             }
         }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Get elements
            const fileInput = document.getElementById('audio-file-input');
            const audioElement = document.getElementById('audio-source');
            const loadingMessage = document.getElementById('loading-message');
            const radioSelect = document.getElementById('radio-select');
            const playRadioBtn = document.getElementById('play-radio-btn');
            const playBuiltinBtn = document.getElementById('play-builtin-btn');
            const speedSlider = document.getElementById('speed-slider');
            const speedValueSpan = document.getElementById('speed-value');
            const loopCheckbox = document.getElementById('loop-checkbox');
            const colorPicker = document.getElementById('bar-color-picker');
            const bgChangeBtn = document.getElementById('bg-change-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn'); // Get theme button

            // Helper function to play audio (same as before)
            function playAudio(element, sourceName) { /* ... same as previous ... */
                const playPromise = element.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        loadingMessage.textContent = `Playing: ${sourceName}`;
                        resumeAudioContext();
                    }).catch(e => {
                        loadingMessage.textContent = `Error playing ${sourceName}. See console.`;
                        console.error(`Error playing ${sourceName} (URL: ${element.src}):`, e);
                        console.error(`Audio Element State: readyState=${element.readyState}, networkState=${element.networkState}, error=`, element.error);
                        if (e.name === 'NotSupportedError') {
                             alert(`Could not play ${sourceName}: The audio format might be unsupported by your browser or the file could be corrupt.\n(readyState: ${element.readyState}, networkState: ${element.networkState})`);
                         } else if (e.name === 'NotAllowedError') {
                              alert(`Playback blocked for ${sourceName}. Please interact with the page (e.g., click background) and try again.`);
                         } else {
                             alert(`Could not play ${sourceName}. There might be a network issue, the file/stream is unavailable, or CORS is blocking it.\nError: ${e.message}\n(readyState: ${element.readyState}, networkState: ${element.networkState})`);
                         }
                    });
                } else {
                     loadingMessage.textContent = `Playing: ${sourceName}`;
                     resumeAudioContext();
                }
             }

            // File Input Listener (same as before)
            fileInput.addEventListener('change', function(event) { /* ... same as previous ... */
                const files = event.target.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
                    currentObjectURL = URL.createObjectURL(file);
                    audioElement.src = currentObjectURL;
                    audioElement.load();
                    loadingMessage.textContent = `Loaded: ${file.name}. Press play!`;
                    console.log("Audio file loaded:", file.name);
                    radioSelect.value = "";
                    setupAudioContextAndSource(audioElement);
                }
             });

             window.addEventListener('beforeunload', () => { if (currentObjectURL) URL.revokeObjectURL(currentObjectURL); });

            // Radio Player Listener (same as before)
            playRadioBtn.addEventListener('click', () => { /* ... same as previous ... */
                const streamUrl = radioSelect.value;
                const stationName = radioSelect.options[radioSelect.selectedIndex].text;
                if (streamUrl) {
                    if (currentObjectURL) { URL.revokeObjectURL(currentObjectURL); currentObjectURL = null; }
                    audioElement.src = streamUrl;
                    audioElement.load();
                    loadingMessage.textContent = `Loading radio: ${stationName}...`;
                    console.log("Attempting to play radio:", streamUrl);
                    fileInput.value = '';
                    setupAudioContextAndSource(audioElement);
                    playAudio(audioElement, stationName);
                } else {
                    loadingMessage.textContent = "Please select a radio station.";
                }
             });

            // Built-in Track Listener (same as before)
            playBuiltinBtn.addEventListener('click', () => { /* ... same as previous ... */
                if (currentObjectURL) { URL.revokeObjectURL(currentObjectURL); currentObjectURL = null; }
                audioElement.src = BUILTIN_TRACK_URL;
                audioElement.load();
                loadingMessage.textContent = `Loading: ${BUILTIN_TRACK_NAME}...`;
                console.log("Attempting to play built-in track:", BUILTIN_TRACK_URL);
                fileInput.value = '';
                radioSelect.value = '';
                setupAudioContextAndSource(audioElement);
                playAudio(audioElement, BUILTIN_TRACK_NAME);
            });

            // Speed Control Listener (same as before)
            speedSlider.addEventListener('input', function() { /* ... same as previous ... */
                const speed = parseFloat(this.value);
                try { audioElement.playbackRate = speed; } catch(e) { console.warn("Could not set playbackRate:", e)}
                speedValueSpan.textContent = `${speed.toFixed(1)}x`;
            });

            // Loop Control Listener (same as before)
            loopCheckbox.addEventListener('change', function() { /* ... same as previous ... */
                audioElement.loop = this.checked;
             });

            // Color Picker Listener (same as before)
            colorPicker.addEventListener('input', function() { /* ... same as previous ... */
                baseBarColor.set(this.value);
             });

            // Background Change Listener (same as before - only affects visualizer bg)
            bgChangeBtn.addEventListener('click', () => { /* ... same as previous ... */
                currentBgIndex = (currentBgIndex + 1) % backgroundColors.length;
                 if (renderer) renderer.setClearColor(backgroundColors[currentBgIndex], 1);
             });

            // Theme Toggle Listener (NEW)
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', handleThemeToggle);
            }
        }


        // --- Animation Loop ---
        // (Function remains the same as previous version)
        function animate() { /* ... same as previous ... */
            requestAnimationFrame(animate);
            controls.update();

            if (isAudioContextInitialized && analyser && dataArray) {
                try {
                    analyser.getByteFrequencyData(dataArray);
                    bars.forEach((bar, i) => {
                        const frequencyValue = dataArray[i];
                        const logValue = Math.log10(frequencyValue + 1) / Math.log10(256);
                        const scaleTarget = (logValue * 80) + 0.1;
                        bar.scale.y += (scaleTarget - bar.scale.y) * 0.2;
                        bar.position.y = (bar.scale.y / 2) - 10;
                        const intensity = frequencyValue / 255;
                        const lightnessFactor = Math.min(1, 0.4 + intensity * 0.8);
                        const emissiveFactor = Math.min(0.8, intensity * 0.8);
                        let baseHSL = {};
                        baseBarColor.getHSL(baseHSL);
                        bar.material.color.setHSL(baseHSL.h, baseHSL.s, baseHSL.l * lightnessFactor);
                        bar.material.emissive.copy(bar.material.color).multiplyScalar(emissiveFactor);
                    });
                } catch (e) {
                    console.error("Error during analyser data processing:", e);
                }

            } else if (bars.length > 0) {
                 bars.forEach(bar => {
                     bar.scale.y += (0.1 - bar.scale.y) * 0.1;
                     bar.position.y = (bar.scale.y / 2) - 10;
                 });
            }

            if (composer) {
                composer.render();
            } else if (renderer) {
                renderer.render(scene, camera);
            }
         }

        // --- Window Resize Handler ---
        // (Function remains the same as previous version)
        function onWindowResize() { /* ... same as previous ... */
            if (camera && renderer) {
                const width = window.innerWidth;
                const height = window.innerHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
                if (composer) { composer.setSize(width, height); }
            }
         }

        // --- Start Everything ---
        window.onload = init;

    </script>
</body>
</html>
