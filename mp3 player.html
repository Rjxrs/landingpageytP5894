<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 3D Audio Visualizer</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind dark mode config
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style type="text/tailwindcss">
        /* Base body styles */
        body {
            @apply font-sans flex flex-col items-center min-h-screen overflow-hidden transition-colors duration-300;
            @apply bg-gray-100 dark:bg-black text-gray-900 dark:text-white;
             padding-top: 60px; /* Adjust for fixed top bar */
        }

        /* Three.js Canvas Styling */
        #visualizer-canvas {
            @apply fixed top-0 left-0 w-full h-full -z-10;
        }

        /* --- Top Bar Styling --- */
        .top-bar {
            @apply fixed top-0 left-0 right-0 z-20 w-full px-4 py-2 flex justify-between items-center min-h-[50px];
            @apply bg-white/80 dark:bg-black/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .time-date {
            @apply text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap transition-colors duration-300;
        }
        .top-bar-controls {
            @apply flex items-center space-x-3;
        }
        .btn-top-bar {
            @apply w-[34px] h-[34px] inline-flex items-center justify-center rounded-full transition-all duration-200;
            @apply bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400;
            @apply hover:bg-gray-300 dark:hover:bg-gray-600 hover:text-blue-600 dark:hover:text-blue-400 hover:scale-105;
        }
        .btn-top-bar i { @apply text-sm; }

        /* Theme switch specific styling */
        .theme-switch-wrapper { @apply flex items-center space-x-2; }
        .theme-switch-wrapper .fa-sun { @apply text-yellow-500 text-lg transition-colors duration-300; }
        .theme-switch-wrapper .fa-moon { @apply text-gray-400 text-lg transition-colors duration-300; }
        .dark .theme-switch-wrapper .fa-sun { @apply text-gray-500; }
        .dark .theme-switch-wrapper .fa-moon { @apply text-indigo-400; }
        .toggle-label { @apply relative block w-10 h-6 rounded-full cursor-pointer bg-gray-300 dark:bg-gray-600 transition-colors duration-300; }
        .toggle-checkbox { @apply absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-200 dark:border-gray-500 dark:bg-gray-300 transition-all duration-300 ease-in-out; top: 2px; left: 2px; }
        .toggle-checkbox:checked { @apply right-0 border-green-400 dark:border-green-500; transform: translateX(calc(100% - 2px)); }
        .toggle-checkbox:checked + .toggle-label { @apply bg-green-400 dark:bg-green-500; }
        /* End Theme Switch Styling */

        /* Controls Container Styling */
        .controls-container {
            @apply bg-white/85 dark:bg-black/85 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100;
            @apply shadow-lg rounded-2xl p-6 mt-5 mb-5;
            @apply flex flex-col items-stretch gap-5 z-10 max-w-xl w-full;
            max-height: calc(100vh - 100px); /* Leave space for top bar and some margin */
            @apply overflow-y-auto backdrop-blur-sm transition-colors duration-300;
             /* Scrollbar styling */
             scrollbar-width: thin;
             scrollbar-color: #a0aec0 #e2e8f0; /* gray-400 gray-200 */
        }
        .dark .controls-container {
             scrollbar-color: #718096 #2d3748; /* gray-500 gray-800 */
        }
        .controls-container::-webkit-scrollbar { width: 8px; }
        .controls-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 4px; }
        .dark .controls-container::-webkit-scrollbar-track { background: #2d3748; }
        .controls-container::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 4px; border: 2px solid #e2e8f0; }
        .dark .controls-container::-webkit-scrollbar-thumb { background-color: #718096; border: 2px solid #2d3748; }

        /* Section titles */
        .section-title {
            @apply text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2 pb-1 border-b border-gray-300 dark:border-gray-600 transition-colors duration-300;
        }

        /* General input/button styling */
        label, button, select { @apply text-sm transition-colors duration-300; }
        input[type="color"], input[type="range"], select, button, label.button-like { /* Target label styled as button */
            @apply px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600;
            @apply bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100;
            @apply cursor-pointer transition-all duration-200 ease-in-out;
        }
        input[type="range"] { @apply p-0 cursor-grab w-full; }
        input[type="color"] { @apply min-h-[38px] p-1 bg-white dark:bg-gray-200; }

        /* Button Hover States */
        button:hover:not(:disabled), label.button-like:hover, select:hover { /* Add :not(:disabled) */
             @apply border-gray-400 dark:border-gray-500 bg-gray-200 dark:bg-gray-600;
        }
        button:disabled { @apply opacity-50 cursor-not-allowed; } /* Style disabled buttons */


        /* Specific Buttons */
        label[for="audio-file-input"], label[for="bg-file-input"] { /* Style file input labels as buttons */
             @apply bg-blue-500 hover:bg-blue-600 text-white border-transparent w-full text-center inline-block; /* Added inline-block */
        }
        #play-builtin-btn { @apply bg-violet-500 hover:bg-violet-600 text-white border-transparent w-full; }
        #play-radio-btn { @apply bg-emerald-500 hover:bg-emerald-600 text-white border-transparent; }
        #bg-cycle-btn { @apply bg-gray-500 hover:bg-gray-600 text-white border-transparent; }
         .dark #bg-cycle-btn { @apply bg-gray-600 hover:bg-gray-500; }


        #audio-file-input, #bg-file-input { @apply hidden; }
        audio { @apply w-full rounded-lg mt-1 filter dark:filter-none; }
        .dark audio { filter: invert(0.9) hue-rotate(180deg) brightness(1.1); }

        .info-text, #loading-message { @apply text-xs text-gray-500 dark:text-gray-400 text-center mt-1 transition-colors duration-300; }
        #loading-message { @apply italic; }

        .control-group { @apply flex items-center gap-2.5; }
        .control-group label:not(.button-like) { @apply flex-shrink-0 w-24 text-xs text-right; } /* Exclude button-like labels */
        .control-group input, .control-group select, .control-group span { @apply flex-grow; }
        .control-group span { @apply text-right text-xs min-w-[40px]; }
        .control-group input[type="checkbox"] { @apply flex-grow-0 w-auto mr-1.5 accent-blue-500 dark:accent-blue-400; }
        optgroup { @apply font-semibold italic text-gray-600 dark:text-gray-400 bg-gray-200 dark:bg-gray-600; }
        option { @apply bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100; }

    </style>
</head>
<body>
    <div class="top-bar" id="top-bar-element">
        <div class="time-date" id="time-date-display">Loading...</div>
        <div class="top-bar-controls">
            <a href="https://rjxrs.github.io/landingpageytP5894/" class="btn-top-bar" title="Homepage">
                <i class="fas fa-home"></i>
            </a>
            <a href="https://rjxrs.github.io/landingpageytP5894/XboxGREPfdowngrader.html" class="btn-top-bar" target="_blank" rel="noopener noreferrer" title="Xbox Downgrader">
                <i class="fab fa-xbox"></i>
            </a>
            <div class="theme-switch-wrapper">
                <i class="fas fa-sun"></i>
                 <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input type="checkbox" name="toggle" id="themeSwitch" class="toggle-checkbox"/>
                    <label for="themeSwitch" class="toggle-label"></label>
                </div>
                 <i class="fas fa-moon"></i>
             </div>
        </div>
    </div>
    <div class="controls-container">
        <div>
            <p class="section-title">Select Audio Source</p>
            <label for="audio-file-input" class="button-like w-full mb-2">Choose Local Audio File</label>
            <input type="file" id="audio-file-input" accept="audio/*, .m4a">
            <button id="play-builtin-btn" class="w-full mb-2">Play Built-in Track: Lock In</button>
            <div class="control-group mb-1">
                <select id="radio-select" class="w-full">
                    <option value="">-- Or Select Radio Station --</option>
                     <optgroup label="Chill / Ambient">
                        <option value="https://somafm.com/groovesalad.pls">SomaFM Groove Salad (PLS)</option>
                        <option value="http://stream-dc4.radioparadise.com/mellow-320">Radio Paradise Mellow Mix (MP3)</option>
                        <option value="https://icecast.radiofrance.fr/fip-hifi.aac">FIP (France) (AAC)</option>
                        <option value="http://stream.klassikradio.de/lounge/mp3-192">Klassik Radio Lounge (Germany) (MP3)</option>
                         <option value="https://streams.ilovemusic.de/iloveradio-chillhop-mp3-128.mp3">I Love Radio Chillhop (Germany) (MP3)</option>
                    </optgroup>
                    <optgroup label="Electronic / Dance">
                        <option value="https://somafm.com/defcon.pls">SomaFM DEF CON Radio (PLS)</option>
                        <option value="https://icecast.omroep.nl/3fm-bb-mp3">NPO 3FM (Netherlands) (MP3)</option>
                        <option value="http://cdn.nrjaudio.fm/audio1/fr/30001/mp3_128.mp3">NRJ France (MP3)</option>
                         <option value="https://stream.frisky.fm/chill_high">Frisky Radio Chill (MP3)</option>
                         <option value="https://uk2.internet-radio.com/proxy/danceradiouk?mp=/stream;">Dance Radio UK (MP3)</option>
                    </optgroup>
                     <optgroup label="Pop / Hits">
                        <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_radio1_mf_p">BBC Radio 1 (UK) (MP3)</option>
                        <option value="https://media-ssl.musicradio.com/CapitalUK">Capital UK (AAC)</option>
                        <option value="http://playerservices.streamtheworld.com/api/livestream-redirect/RADIO538AAC.aac">Radio 538 (Netherlands) (AAC)</option>
                        <option value="http://haydn.torontocast.com:2199/stream/los40principales_alternative_es">Los40 Principales (Spain) (MP3 - Alt)</option>
                        <option value="http://icecast.rtl.it/RTL1025.mp3">RTL 102.5 (Italy) (MP3)</option>
                        <option value="https://streams.planetradio.de/planetradio/mp3/hqlivestream.mp3">Planet Radio (Germany) (MP3)</option>
                        <option value="http://stream.kissfm.de/kissfm/mp3-128/internetradio/">Kiss FM (Germany) (MP3)</option>
                         <option value="http://playerservices.streamtheworld.com/api/livestream-redirect/KIISFMAAC.aac">KIIS FM (USA) (AAC)</option>
                    </optgroup>
                    <optgroup label="Rock / Alternative">
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_6music_mf_p">BBC Radio 6 Music (UK) (MP3)</option>
                         <option value="https://stream.radioparadise.com/aac-192">Radio Paradise Main (AAC)</option>
                         <option value="http://stream.antenne.de/rockantenne/stream/mp3">Rock Antenne (Germany) (MP3)</option>
                         <option value="http://rne.rtveradio.cires21.com/rne_r3.mp3">RNE Radio 3 (Spain) (MP3)</option>
                         <option value="http://stream0.ouestfrance.fr/virginradio-128.mp3">Europe 2 (France) (MP3)</option>
                    </optgroup>
                    <optgroup label="Talk / News">
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_radio4fm_mf_p">BBC Radio 4 (UK) (MP3)</option>
                         <option value="http://st01.dlf.de/dlf/01/128/mp3/stream.mp3">Deutschlandfunk (Germany) (MP3)</option>
                         <option value="https://icecast.radiofrance.fr/franceinter-hifi.aac">France Inter (AAC)</option>
                         <option value="https://icecast.omroep.nl/radio1-bb-mp3">NPO Radio 1 (Netherlands) (MP3)</option>
                         <option value="https://npr-ice.streamguys1.com/live.mp3">NPR (USA) (MP3)</option>
                    </optgroup>
                    <optgroup label="Classical">
                         <option value="http://stream.srg-ssr.ch/m/rsc_de/mp3_128">Radio Swiss Classic (MP3)</option>
                         <option value="http://bbcmedia.ic.llnwd.net/stream/bbcmedia_radio3_mf_p">BBC Radio 3 (UK) (MP3)</option>
                         <option value="http://stream.klassikradio.de/purebach/mp3-192/">Klassik Radio - Pure Bach (MP3)</option>
                         <option value="https://stream.veniceclassicradio.eu/stream">Venice Classic Radio (Italy) (MP3)</option>
                    </optgroup>
                    <optgroup label="Jazz">
                        <option value="http://stream.srg-ssr.ch/m/rsj/mp3_128">Radio Swiss Jazz (MP3)</option>
                        <option value="https://js.streamguys1.com/live">Jazz24 (USA) (AAC)</option>
                        <option value="https://jazzlounge.ice.infomaniak.ch/jazzlounge-high.mp3">Jazz Lounge (Switzerland) (MP3)</option>
                    </optgroup>
                </select>
                <button id="play-radio-btn" class="px-3 py-1 rounded flex-shrink-0">Play</button>
            </div>
            <p id="loading-message" class="info-text">Select a source above.</p>
            <p class="info-text">Tip: Use standard MP3, AAC(.m4a), WAV, or Ogg files.</p>
            <p class="info-text">Radio streams depend on external sources & CORS.</p>
        </div>

         <div>
            <p class="section-title">Audio Player</p>
            <audio id="audio-source" controls crossorigin="anonymous" class="w-full rounded"></audio>
         </div>

        <div>
            <p class="section-title">Playback Controls</p>
            <div class="control-group">
                <label for="speed-slider">Speed:</label>
                <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                <span id="speed-value">1.0x</span>
            </div>
            <div class="control-group mt-2">
                 <label for="loop-checkbox" class="w-auto">Loop:</label> <input type="checkbox" id="loop-checkbox">
                 <span class="flex-grow info-text text-left pl-2">(Local/Built-in only)</span>
             </div>
             <div class="control-group mt-2">
                <label for="volume-slider">Volume:</label>
                <input type="range" id="volume-slider" min="0.0" max="1.0" step="0.05" value="1.0">
                <span id="volume-value">100%</span>
            </div>
             <p class="info-text mt-2">Quality depends on source.</p>
        </div>

        <div>
            <p class="section-title">Visualizer Options</p>
            <div class="control-group">
                <label for="bar-color-picker">Bar Color:</label>
                <input type="color" id="bar-color-picker" value="#00ffcc">
             </div>
             <div class="control-group mt-2">
                 <label for="bg-select">Background:</label>
                 <select id="bg-select" class="flex-grow">
                     <option value="cycle" selected>Cycle Colors</option>
                     <option value="local">Upload Local Image</option>
                     <option value="preset_space">Preset: Space</option>
                     <option value="preset_abstract">Preset: Abstract Waves</option>
                     <option value="preset_gradient">Preset: Gradient</option>
                 </select>
                 <button id="bg-cycle-btn" class="px-3 py-1 rounded flex-shrink-0" title="Cycle Colors (if selected)">Cycle</button>
             </div>
             <div class="control-group mt-2 hidden" id="bg-file-controls">
                 <label for="bg-file-input" class="button-like flex-grow text-center">Choose BG Image</label>
                 <input type="file" id="bg-file-input" accept="image/*">
             </div>
             <p class="info-text mt-2">Visualizer Controls: LMB/1-Finger = Rotate, MMB/Scroll/2-Finger Pinch = Zoom, RMB/2-Finger Drag = Pan.</p>
        </div>
    </div>
    <canvas id="visualizer-canvas"></canvas>

    <script>
        // --- Global Variables ---
        let scene, camera, renderer, controls, composer;
        let audioContext, analyser, source, dataArray, bufferLength;
        const bars = [];
        const NUM_BARS = 128;
        let isAudioContextInitialized = false;
        let currentObjectURL = null;
        let currentBgObjectURL = null;
        let baseBarColor = new THREE.Color(0x00ffcc);
        const backgroundColors = [0x000000, 0x1a1a2a, 0x2a1a1a, 0x1a2a1a, 0x2a2a4a];
        let currentBgIndex = 0;
        const BUILTIN_TRACK_URL = "https://rjxrs.github.io/landingpageytP5894/lock-in.mp3";
        const BUILTIN_TRACK_NAME = "Lock In";
        let timeDateInterval;
        const textureLoader = new THREE.TextureLoader();

        // *** Updated Preset Background URLs (Static Images) ***
        const predefinedBackgrounds = {
            preset_space: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop&w=1471&q=80',
            preset_abstract: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1473&q=80',
            preset_gradient: 'https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1429&q=80'
        };

        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- Top Bar JS ---
            const themeSwitch = document.getElementById('themeSwitch');
            const htmlElement = document.documentElement; // Target <html> for dark class
            const timeDateDisplay = document.getElementById('time-date-display');

            const applyGlobalTheme = (theme) => {
                if (theme === 'dark') {
                    htmlElement.classList.add('dark');
                } else {
                    htmlElement.classList.remove('dark');
                }
                if (themeSwitch) {
                    themeSwitch.checked = (theme === 'dark');
                }
            };

            const getPreferredGlobalTheme = () => {
                const storedTheme = localStorage.getItem('theme');
                return storedTheme ? storedTheme : 'dark'; // Defaulting to dark
            };

            const currentGlobalTheme = getPreferredGlobalTheme();
            applyGlobalTheme(currentGlobalTheme);

            if (themeSwitch) {
                themeSwitch.addEventListener('change', () => {
                    const newTheme = themeSwitch.checked ? 'dark' : 'light';
                    applyGlobalTheme(newTheme);
                    localStorage.setItem('theme', newTheme);
                });
            } else { console.warn("Theme switch element not found."); }

            const updateTimeDate = () => {
                if (timeDateDisplay) {
                    const now = new Date();
                    const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                    const optionsTime = { hour: 'numeric', minute: '2-digit' };
                     try {
                        const formattedDate = now.toLocaleDateString(undefined, optionsDate);
                        const formattedTime = now.toLocaleTimeString(undefined, optionsTime);
                        timeDateDisplay.textContent = `${formattedDate} | ${formattedTime}`;
                    } catch (e) {
                         console.error("Error formatting date/time:", e);
                         timeDateDisplay.textContent = now.toDateString() + " " + now.toTimeString().substring(0,5);
                    }
                } else { console.warn("Time/Date display element not found."); }
            };
            updateTimeDate();
            if(timeDateInterval) clearInterval(timeDateInterval);
            timeDateInterval = setInterval(updateTimeDate, 1000 * 30);


            // --- MP3 Visualizer JS ---

            function initVisualizer() {
                try {
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    camera.position.set(0, 15, 60);
                    const canvas = document.getElementById('visualizer-canvas');
                    if (!canvas) throw new Error("Visualizer canvas not found!");

                    renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    // Initial background setup will be handled by updateBackgroundDisplay called later
                    renderer.setPixelRatio(window.devicePixelRatio);

                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true; controls.dampingFactor = 0.05;
                    controls.minDistance = 10; controls.maxDistance = 250; controls.target.set(0, 0, 0);

                    // Create visualizer bars
                    const barRadius = 0.3, spacing = 0.3;
                    const totalWidth = (barRadius * 2 + spacing) * NUM_BARS;
                    const startX = -totalWidth / 2 + barRadius;
                    const geometry = new THREE.CylinderGeometry(barRadius, barRadius, 1, 16);
                    const material = new THREE.MeshPhongMaterial({
                        color: baseBarColor.clone(), emissive: baseBarColor.clone().multiplyScalar(0.3),
                        specular: 0x222222, shininess: 60, side: THREE.DoubleSide });
                    bars.length = 0;
                    for (let i = 0; i < NUM_BARS; i++) {
                        const barMaterial = material.clone();
                        const bar = new THREE.Mesh(geometry, barMaterial);
                        bar.position.x = startX + i * (barRadius * 2 + spacing);
                        bar.scale.y = 0.1;
                        scene.add(bar); bars.push(bar);
                    }

                    // Lighting
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); scene.add(ambientLight);
                    const pointLight = new THREE.PointLight(0xaaaaff, 0.8, 500); pointLight.position.set(0, 50, 60); scene.add(pointLight);
                    const pointLight2 = new THREE.PointLight(0xffaaaa, 0.5, 500); pointLight2.position.set(-60, 30, 40); scene.add(pointLight2);

                    // Post Processing (Bloom)
                    if (typeof THREE.EffectComposer !== 'undefined') {
                        const renderScene = new THREE.RenderPass(scene, camera);
                        const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85);
                        composer = new THREE.EffectComposer(renderer);
                        composer.addPass(renderScene); composer.addPass(bloomPass);
                    } else { console.warn("Bloom effect disabled: Postprocessing components not found."); }

                    setupAudioEventListeners(); // Setup listeners AFTER elements are available
                    animate(); // Start animation loop
                    window.addEventListener('resize', onWindowResize, false);
                    console.log("Visualizer Initialized.");

                } catch (e) {
                    console.error("Error during visualizer initialization:", e);
                    alert("Could not initialize visualizer: " + e.message);
                }
            }

            function setupAudioContextAndSource(audioElement) {
                if (isAudioContextInitialized && source && source.mediaElement === audioElement) {
                    resumeAudioContext(); return;
                }
                 if (isAudioContextInitialized && source && source.mediaElement !== audioElement) {
                      console.log("Audio element changed, reconnecting source...");
                      if (source) { try { source.disconnect(); } catch (e) { console.warn("Error disconnecting previous source:", e); } }
                      source = null;
                 }
                try {
                    if (!audioContext) {
                         console.log("Creating new AudioContext and Analyser...");
                         audioContext = new (window.AudioContext || window.webkitAudioContext)();
                         analyser = audioContext.createAnalyser();
                         analyser.fftSize = NUM_BARS * 2;
                         analyser.minDecibels = -90; analyser.maxDecibels = -10; analyser.smoothingTimeConstant = 0.85;
                         bufferLength = analyser.frequencyBinCount;
                         dataArray = new Uint8Array(bufferLength);
                         analyser.connect(audioContext.destination);
                    }
                    source = audioContext.createMediaElementSource(audioElement);
                    source.connect(analyser);
                    isAudioContextInitialized = true;
                    console.log("AudioContext Initialized/Source Connected.");
                    if (!audioElement.dataset.playListenerAdded) {
                         audioElement.addEventListener('play', resumeAudioContext);
                         audioElement.dataset.playListenerAdded = 'true';
                    }
                    document.body.addEventListener('click', resumeAudioContext, { once: true });
                    document.body.addEventListener('touchend', resumeAudioContext, { once: true });
                } catch (e) {
                    console.error("Fatal Error setting up Web Audio API:", e);
                    const loadingMsg = document.getElementById('loading-message');
                    if(loadingMsg) loadingMsg.textContent = "Error initializing audio.";
                    alert("Web Audio API setup failed: " + e.message);
                    isAudioContextInitialized = false;
                }
            }

            function resumeAudioContext() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => console.log("AudioContext Resumed."))
                    .catch(e => console.error("Error resuming AudioContext:", e));
                }
            }

            function setupAudioEventListeners() {
                const fileInput = document.getElementById('audio-file-input');
                const audioElement = document.getElementById('audio-source');
                const loadingMessage = document.getElementById('loading-message');
                const radioSelect = document.getElementById('radio-select');
                const playRadioBtn = document.getElementById('play-radio-btn');
                const playBuiltinBtn = document.getElementById('play-builtin-btn');
                const speedSlider = document.getElementById('speed-slider');
                const speedValueSpan = document.getElementById('speed-value');
                const loopCheckbox = document.getElementById('loop-checkbox');
                const colorPicker = document.getElementById('bar-color-picker');
                const bgSelect = document.getElementById('bg-select');
                const bgCycleBtn = document.getElementById('bg-cycle-btn');
                const bgFileInput = document.getElementById('bg-file-input');
                const bgFileControls = document.getElementById('bg-file-controls');
                const volumeSlider = document.getElementById('volume-slider');
                const volumeValueSpan = document.getElementById('volume-value');

                if (!audioElement) { console.error("Audio element not found!"); return; }

                function playAudio(element, sourceName) {
                    if (!isAudioContextInitialized) setupAudioContextAndSource(element);
                    if (!isAudioContextInitialized) { alert("Audio system could not be initialized."); if(loadingMessage) loadingMessage.textContent = "Audio init failed."; return; }
                    resumeAudioContext();
                    const playPromise = element.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => { if(loadingMessage) loadingMessage.textContent = `Playing: ${sourceName}`; })
                        .catch(e => {
                            if(loadingMessage) loadingMessage.textContent = `Error playing ${sourceName}.`;
                            console.error(`Play Error (${sourceName}):`, e);
                            if (e.name === 'NotAllowedError') alert(`Playback blocked. Click page/player & try again.`);
                            else if (e.name === 'NotSupportedError') alert(`Audio format might be unsupported.`);
                            else alert(`Could not play. Network/CORS issue or file unavailable?`);
                        });
                    } else { if(loadingMessage) loadingMessage.textContent = `Playing: ${sourceName}`; }
                }

                if (fileInput) fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
                        currentObjectURL = URL.createObjectURL(file);
                        audioElement.src = currentObjectURL; audioElement.load();
                        if(loadingMessage) loadingMessage.textContent = `Loaded: ${file.name}. Press play!`;
                        if(radioSelect) radioSelect.value = "";
                        setupAudioContextAndSource(audioElement);
                    }
                });
                window.addEventListener('beforeunload', () => { if (currentObjectURL) URL.revokeObjectURL(currentObjectURL); if (currentBgObjectURL) URL.revokeObjectURL(currentBgObjectURL); });

                if (playRadioBtn && radioSelect) playRadioBtn.addEventListener('click', () => {
                    const streamUrl = radioSelect.value; const stationName = radioSelect.options[radioSelect.selectedIndex].text;
                    if (streamUrl) {
                        if (currentObjectURL) { URL.revokeObjectURL(currentObjectURL); currentObjectURL = null; }
                        audioElement.src = streamUrl; audioElement.load();
                        if(loadingMessage) loadingMessage.textContent = `Loading: ${stationName}...`;
                        if(fileInput) fileInput.value = '';
                        setupAudioContextAndSource(audioElement);
                        playAudio(audioElement, stationName);
                    } else { if(loadingMessage) loadingMessage.textContent = "Select a radio station."; }
                });

                if (playBuiltinBtn) playBuiltinBtn.addEventListener('click', () => {
                    if (currentObjectURL) { URL.revokeObjectURL(currentObjectURL); currentObjectURL = null; }
                    audioElement.src = BUILTIN_TRACK_URL; audioElement.load();
                    if(loadingMessage) loadingMessage.textContent = `Loading: ${BUILTIN_TRACK_NAME}...`;
                    if(fileInput) fileInput.value = ''; if(radioSelect) radioSelect.value = '';
                    setupAudioContextAndSource(audioElement);
                    playAudio(audioElement, BUILTIN_TRACK_NAME);
                });

                if (speedSlider && speedValueSpan) speedSlider.addEventListener('input', function() {
                    const speed = parseFloat(this.value);
                    try { audioElement.playbackRate = speed; } catch(e) { console.warn("Could not set playbackRate:", e)}
                    speedValueSpan.textContent = `${speed.toFixed(1)}x`;
                });

                if (loopCheckbox) loopCheckbox.addEventListener('change', function() { audioElement.loop = this.checked; });

                 // Volume Control Listener
                if (volumeSlider && volumeValueSpan) volumeSlider.addEventListener('input', function() {
                    const volume = parseFloat(this.value);
                    audioElement.volume = volume; // Set audio volume
                    volumeValueSpan.textContent = `${Math.round(volume * 100)}%`;
                });


                if (colorPicker) colorPicker.addEventListener('input', function() { baseBarColor.set(this.value); });

                // --- Background Controls Logic ---
                function updateBackgroundDisplay(type) {
                     if (!renderer || !scene) return;
                     // Revoke previous local BG URL if it exists
                     if (currentBgObjectURL) { URL.revokeObjectURL(currentBgObjectURL); currentBgObjectURL = null; }

                     if (type === 'cycle') {
                         scene.background = null; // Use clear color
                         renderer.setClearColor(backgroundColors[currentBgIndex], 1);
                         if (bgCycleBtn) bgCycleBtn.disabled = false;
                         if (bgFileControls) bgFileControls.classList.add('hidden');
                     } else if (type === 'local') {
                         scene.background = null; // Clear background while waiting for file
                         renderer.setClearColor(backgroundColors[currentBgIndex], 1); // Fallback color
                         if (bgCycleBtn) bgCycleBtn.disabled = true;
                         if (bgFileControls) bgFileControls.classList.remove('hidden');
                         // File loading is handled by bgFileInput listener below
                     } else if (predefinedBackgrounds[type]) {
                         if (bgCycleBtn) bgCycleBtn.disabled = true;
                         if (bgFileControls) bgFileControls.classList.add('hidden');
                         const imageUrl = predefinedBackgrounds[type];
                         console.log("Loading texture:", imageUrl);
                         // Add CORS proxy if needed, or ensure direct links allow cross-origin
                         textureLoader.load(
                             imageUrl,
                             (texture) => { // onLoad
                                 texture.colorSpace = THREE.SRGBColorSpace;
                                 scene.background = texture;
                                 renderer.setClearColor(0x000000, 0); // Make clear color transparent
                                 console.log("Texture loaded successfully");
                             },
                             undefined, // onProgress
                             (error) => { // onError
                                 console.error('Error loading texture:', error);
                                 alert(`Failed to load predefined background image. Check console for details. URL: ${imageUrl}`);
                                 scene.background = null; // Fallback to color
                                 renderer.setClearColor(backgroundColors[currentBgIndex], 1);
                                 if(bgSelect) bgSelect.value = 'cycle'; // Reset dropdown
                                 if (bgCycleBtn) bgCycleBtn.disabled = false;
                             }
                         );
                     }
                 }

                if (bgSelect) bgSelect.addEventListener('change', (e) => updateBackgroundDisplay(e.target.value));

                if (bgCycleBtn) bgCycleBtn.addEventListener('click', () => {
                    if (bgSelect && bgSelect.value === 'cycle') {
                        currentBgIndex = (currentBgIndex + 1) % backgroundColors.length;
                        if (renderer) renderer.setClearColor(backgroundColors[currentBgIndex], 1);
                    }
                });

                if (bgFileInput) bgFileInput.addEventListener('change', function(event) {
                     const file = event.target.files[0];
                     if (file && bgSelect && bgSelect.value === 'local') {
                          if (currentBgObjectURL) URL.revokeObjectURL(currentBgObjectURL);
                          currentBgObjectURL = URL.createObjectURL(file);
                          console.log("Loading local BG texture:", currentBgObjectURL);
                          textureLoader.load(
                              currentBgObjectURL,
                              (texture) => {
                                  texture.colorSpace = THREE.SRGBColorSpace;
                                  scene.background = texture;
                                  renderer.setClearColor(0x000000, 0);
                                  console.log("Local BG texture loaded.");
                              },
                              undefined,
                              (error) => {
                                  console.error('Error loading local BG texture:', error);
                                  alert('Failed to load local background image. Ensure it is a valid image format.');
                                  if (currentBgObjectURL) { URL.revokeObjectURL(currentBgObjectURL); currentBgObjectURL = null; }
                                  scene.background = null;
                                  renderer.setClearColor(backgroundColors[currentBgIndex], 1);
                                  if(bgSelect) bgSelect.value = 'cycle'; // Reset dropdown
                                  if (bgCycleBtn) bgCycleBtn.disabled = false;
                                  if (bgFileControls) bgFileControls.classList.add('hidden');

                              }
                          );
                     }
                 });

                 // Initial background setup based on dropdown
                 if(bgSelect) updateBackgroundDisplay(bgSelect.value);

            } // End setupAudioEventListeners

            /** Animation loop */
            function animate() {
                requestAnimationFrame(animate);
                if(controls) controls.update();

                if (isAudioContextInitialized && analyser && dataArray) {
                    try {
                        analyser.getByteFrequencyData(dataArray);
                        bars.forEach((bar, i) => {
                            const frequencyValue = dataArray[i];
                            const logValue = Math.log10(frequencyValue + 1) / Math.log10(256);
                            const scaleTarget = Math.max(0.1, logValue * 80);
                            bar.scale.y += (scaleTarget - bar.scale.y) * 0.2;
                            bar.position.y = (bar.scale.y / 2) - 10;

                            const intensity = frequencyValue / 255;
                            const lightnessFactor = Math.min(1, 0.4 + intensity * 0.8);
                            const emissiveFactor = Math.min(0.8, intensity * 0.8);
                            let baseHSL = {}; baseBarColor.getHSL(baseHSL);
                            if (bar.material?.color && bar.material?.emissive) {
                                bar.material.color.setHSL(baseHSL.h, baseHSL.s, baseHSL.l * lightnessFactor);
                                bar.material.emissive.copy(bar.material.color).multiplyScalar(emissiveFactor);
                            }
                        });
                    } catch (e) { /* Ignore analyser errors if context closes */ }
                } else if (bars.length > 0) {
                     bars.forEach(bar => { bar.scale.y += (0.1 - bar.scale.y) * 0.1; bar.position.y = (bar.scale.y / 2) - 10; });
                }

                if (composer) composer.render();
                else if (renderer) renderer.render(scene, camera);
            }

            /** Handles window resize */
            function onWindowResize() {
                if (camera && renderer) {
                    const width = window.innerWidth; const height = window.innerHeight;
                    camera.aspect = width / height; camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                    if (composer) composer.setSize(width, height);
                }
            }

            // --- Start Everything ---
            initVisualizer(); // Initialize Three.js and event listeners

        }); // End DOMContentLoaded
    </script>
</body>
</html>
