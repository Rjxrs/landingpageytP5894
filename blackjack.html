<!DOCTYPE html>
<html lang="en" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Blackjack Deluxe V3 ✨</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        // Tailwind config V3 - Refined colors
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', '"Liberation Mono"', '"Courier New"', 'monospace'],
                    },
                    colors: {
                        // Core Palette
                        'primary-light': '#3b82f6', 'primary-dark': '#60a5fa',
                        'success-light': '#10b981', 'success-dark': '#34d399',
                        'danger-light': '#ef4444', 'danger-dark': '#f87171',
                        'warning-light': '#f59e0b', 'warning-dark': '#fcd34d',

                        // Backgrounds
                        'bkg-light': '#f9fafb', // gray-50
                        'bkg-dark': '#111827', // gray-900
                        'panel-light': '#ffffff', // white
                        'panel-dark': '#1f2937', // gray-800

                        // Game area - Solid Green
                        'game-area-light': '#15803d', // green-700
                        'game-area-dark': '#166534', // green-800
                        'game-border-light': 'rgba(133, 77, 14, 0.7)', // Slightly darker SaddleBrown-like border
                        'game-border-dark': 'rgba(161, 98, 7, 0.8)',

                        // Text
                        'text-main-light': '#111827', 'text-main-dark': '#f3f4f6',
                        'text-secondary-light': '#4b5563', 'text-secondary-dark': '#9ca3af',
                        'text-muted-light': '#6b7280', 'text-muted-dark': '#9ca3af',
                        'text-heading-light': '#1f2937', 'text-heading-dark': '#e5e7eb',
                        'text-on-green': '#ffffff',

                        // Borders
                        'border-light': '#e5e7eb', 'border-dark': '#374151',

                        // Top Bar specific
                        'topbar-bg-light': 'rgba(255, 255, 255, 0.9)', 'topbar-bg-dark': 'rgba(17, 24, 39, 0.9)',
                        'topbar-border-light': '#e5e7eb', 'topbar-border-dark': '#374151',
                        'icon-btn-light': '#f3f4f6', 'icon-btn-dark': '#374151',
                        'icon-btn-hover-light': '#e5e7eb', 'icon-btn-hover-dark': '#4b5563',
                        'icon-color-light': '#4b5563', 'icon-color-dark': '#9ca3af',
                        'icon-hover-light': '#1e293b', 'icon-hover-dark': '#e5e7eb',

                        // Card specific
                        'card-bg-light': '#ffffff',
                        'card-bg-dark': '#e5e7eb', // Light gray bg for dark mode cards
                        'card-border-light': '#d1d5db',
                        'card-border-dark': '#9ca3af',
                        'text-red-light': '#dc2626', 'text-red-dark': '#b91c1c',
                        'text-black-light': '#1f2937', 'text-black-dark': '#111827',
                        'card-back-light': '#b91c1c', // Dark Red back
                        'card-back-dark': '#991b1b', // Darker Red back

                        // Button specific
                        'button-deal': '#10b981', 'button-deal-hover': '#059669',
                        'button-hit': '#3b82f6', 'button-hit-hover': '#2563eb',
                        'button-stand': '#ef4444', 'button-stand-hover': '#dc2626',
                        'button-new': '#6b7280', 'button-new-hover': '#4b5563',
                        'button-new-text-dark': '#d1d5db', // Lighter text for New Game button in dark mode
                    },
                    boxShadow: {
                        'soft-light': '0 4px 10px -1px rgba(0, 0, 0, 0.07), 0 2px 6px -2px rgba(0, 0, 0, 0.06)',
                        'soft-dark': '0 4px 10px -1px rgba(0, 0, 0, 0.4), 0 2px 6px -2px rgba(0, 0, 0, 0.35)',
                        'card': '0 2px 4px 0 rgba(0, 0, 0, 0.1)',
                        'card-dark': '0 2px 4px 0 rgba(0, 0, 0, 0.4)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)',
                        'inner-dark': 'inset 0 1px 3px 0 rgba(0, 0, 0, 0.5)',
                    },
                    keyframes: {
                        spin: { '0%': { transform: 'rotate(0deg)' }, '100%': { transform: 'rotate(360deg)' } },
                        'deal-card': { // Updated animation
                            '0%': { transform: 'translateY(-40px) rotateX(30deg)', opacity: '0' },
                            '60%': { transform: 'translateY(5px) rotateX(-5deg)', opacity: '1'},
                            '100%': { transform: 'translateY(0) rotateX(0deg)', opacity: '1' },
                        }
                    },
                    animation: {
                       spin: 'spin 0.8s linear infinite',
                       'deal-card': 'deal-card 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards', // Reference keyframe
                    }
                }
            }
        }
    </script>
    <style>
        /* Standard CSS for animations */
        @keyframes deal-card {
            0% { transform: translateY(-40px) rotateX(30deg); opacity: 0; }
            60% { transform: translateY(5px) rotateX(-5deg); opacity: 1; } /* Add bounce */
            100% { transform: translateY(0) rotateX(0deg); opacity: 1; }
        }
        /* Class to apply animation via JS */
        .animate-deal-card {
            animation: deal-card 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Base styles */
        body {
            font-family: theme('fontFamily.sans');
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: theme('colors.bkg-light');
            padding-top: 60px; /* Padding for fixed top bar */
        }
        .dark body { background-color: theme('colors.bkg-dark'); }
        /* Apply transitions more selectively */
        .main-panel, .top-bar, .top-bar-icon-btn, .playing-card, .game-button, #message-area {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }
        .top-bar-icon-btn, .game-button, .playing-card { /* Add playing-card here */
             transition-property: background-color, border-color, color, box-shadow, transform, opacity;
             transition-duration: 150ms;
        }

        /* Panel Styling */
        .main-panel {
            background-color: theme('colors.panel-light');
            border: 1px solid theme('colors.border-light');
        }
        .dark .main-panel {
            background-color: theme('colors.panel-dark');
            border: 1px solid theme('colors.border-dark');
        }

        /* Theme Toggle Icons */
        #theme-toggle-light-icon, #theme-toggle-dark-icon { display: none; }

        /* Top Bar Styles */
        .top-bar { /* ... same styles ... */
            position: fixed; top: 0; left: 0; right: 0; z-index: 50; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 1rem; padding-right: 1rem; /* px-4 */
             @media (min-width: 640px) { padding-left: 1.5rem; padding-right: 1.5rem; } /* sm:px-6 */
            box-shadow: theme('boxShadow.md');
            background-color: theme('colors.topbar-bg-light');
            border-bottom: 1px solid theme('colors.topbar-border-light');
            backdrop-filter: blur(4px);
        }
        .dark .top-bar {
             background-color: theme('colors.topbar-bg-dark');
             border-bottom-color: theme('colors.topbar-border-dark');
        }
        .time-date { /* ... same styles ... */
             font-size: 0.75rem; /* text-xs */
             @media (min-width: 640px) { font-size: 0.875rem; } /* sm:text-sm */
             color: theme('colors.text-secondary-light');
             white-space: nowrap;
        }
        .dark .time-date { color: theme('colors.text-secondary-dark'); }
        .top-bar-controls { display: flex; align-items: center; gap: 0.75rem; /* space-x-3 */ }
         @media (min-width: 640px) { .top-bar-controls { gap: 0.75rem; } } /* sm:space-x-3 */

        .top-bar-icon-btn { /* ... same styles ... */
             display: inline-flex; align-items: center; justify-content: center;
             width: 2rem; height: 2rem; /* w-8 h-8 */
             border-radius: 9999px; /* rounded-full */
             background-color: theme('colors.icon-btn-light');
             color: theme('colors.icon-color-light');
        }
         .dark .top-bar-icon-btn { background-color: theme('colors.icon-btn-dark'); color: theme('colors.icon-color-dark'); }
         .top-bar-icon-btn:hover { background-color: theme('colors.icon-btn-hover-light'); color: theme('colors.icon-hover-light'); transform: scale(1.05); }
         .dark .top-bar-icon-btn:hover { background-color: theme('colors.icon-btn-hover-dark'); color: theme('colors.icon-hover-dark'); }
         .top-bar-icon-btn:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); --tw-ring-color: theme('colors.primary-light'); }
         .dark .top-bar-icon-btn:focus { --tw-ring-color: theme('colors.primary-dark'); }
         .top-bar-icon-btn i { font-size: 0.875rem; /* text-sm */ }

        /* Blackjack Game Specific Styles */
        .game-area {
            min-height: 280px;
            background-color: theme('colors.game-area-light'); /* Solid green */
            border: 4px solid theme('colors.game-border-light'); /* Table edge */
            box-shadow: theme('boxShadow.inner-light'); /* Inner shadow */
        }
        .dark .game-area {
            background-color: theme('colors.game-area-bg-dark');
            border-color: theme('colors.game-border-dark');
            box-shadow: theme('boxShadow.inner-dark');
        }
        .hand-container {
            min-height: 110px;
            padding: 0.75rem; /* p-3 */
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem; /* Slightly increased gap */
            align-items: center;
            justify-content: center;
        }
        /* White text for titles on green background */
        .game-area h2 { color: theme('colors.text-on-green'); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .game-area h2 span { color: theme('colors.text-on-green'); font-weight: bold; }

        .playing-card {
            display: inline-flex; flex-direction: column; align-items: center; justify-content: space-between;
            border: 1px solid theme('colors.card-border-light');
            background-color: theme('colors.card-bg-light'); /* Solid background */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.6rem 0.3rem;
            margin: 0.25rem;
            min-width: 65px;
            min-height: 95px;
            box-shadow: theme('boxShadow.card');
            font-family: theme('fontFamily.mono');
            font-weight: 700; /* bold */
            user-select: none;
            position: relative;
            transform: scale(1);
            /* Animation applied via JS */
            /* opacity: 0; */ /* Start visible, animation handles fade-in */
        }
         .playing-card:hover {
             transform: translateY(-3px) scale(1.03);
             box-shadow: theme('boxShadow.lg');
         }
        .dark .playing-card {
            border-color: theme('colors.card-border-dark');
            background-color: theme('colors.card-bg-dark');
            box-shadow: theme('boxShadow.card-dark');
        }
        .dark .playing-card:hover { box-shadow: theme('boxShadow.xl'); }

        .playing-card .suit {
            font-size: 1.5rem; /* text-2xl */
            line-height: 1;
        }
        .playing-card .rank {
             font-size: 1.875rem; /* text-3xl */
             line-height: 1.1;
        }
        .playing-card.red { color: theme('colors.text-red-light'); }
        .playing-card.black { color: theme('colors.text-black-light'); }
        .dark .playing-card.red { color: theme('colors.text-red-dark'); }
        .dark .playing-card.black { color: theme('colors.text-black-dark'); }

        /* Style for hidden card - Solid Color Back */
        .playing-card.hidden-card {
             background-color: theme('colors.card-back-light');
             border-color: theme('colors.card-back-light');
             color: transparent;
             /* Optional: Add a subtle pattern or texture if desired */
             /* background-image: url('path/to/card-back-pattern.svg'); */
        }
         .dark .playing-card.hidden-card {
             background-color: theme('colors.card-back-dark');
             border-color: theme('colors.card-back-dark');
         }
         .playing-card.hidden-card .rank, .playing-card.hidden-card .suit { visibility: hidden; }


        /* Game Buttons - Enhanced */
        .game-button {
            @apply px-5 py-2 rounded-lg font-semibold text-sm shadow-md transition-all duration-200 ease-in-out;
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-panel-dark;
            @apply disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100;
            @apply hover:scale-105 active:scale-95;
        }
        #deal-button { @apply bg-success-light hover:bg-opacity-80 text-white focus:ring-success-light; }
        .dark #deal-button { @apply bg-success-dark hover:bg-opacity-80 focus:ring-success-dark; }
        #hit-button { @apply bg-primary-light hover:bg-opacity-80 text-white focus:ring-primary-light; }
        .dark #hit-button { @apply bg-primary-dark hover:bg-opacity-80 focus:ring-primary-dark; }
        #stand-button { @apply bg-danger-light hover:bg-opacity-80 text-white focus:ring-danger-light; }
        .dark #stand-button { @apply bg-danger-dark hover:bg-opacity-80 focus:ring-danger-dark; }
        #new-game-button { @apply bg-text-secondary-light hover:bg-opacity-80 text-white focus:ring-gray-500; }
        /* Fixed New Game button text color in dark mode */
        .dark #new-game-button { @apply bg-text-secondary-dark hover:bg-opacity-80 text-text-main-dark focus:ring-gray-400; }

        /* Message Area Styling */
        #message-area {
             @apply text-center text-xl font-bold h-8 my-5 transition-colors duration-300;
             color: theme('colors.text-on-green'); /* White on green */
             text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Stronger shadow on green */
        }
        /* Add classes via JS for different message types */
        #message-area.win { color: theme('colors.success-dark'); font-weight: 700; } /* Bold on win */
        #message-area.lose { color: theme('colors.danger-dark'); font-weight: 700; } /* Bold on lose */
        #message-area.info { color: theme('colors.primary-dark'); }
        #message-area.warn { color: theme('colors.warning-dark'); }
        .dark #message-area.win, .dark #message-area.lose, .dark #message-area.info, .dark #message-area.warn {
             /* Keep same colors in dark mode as they contrast well */
        }

    </style>
</head>
<body class="text-text-main-light dark:text-text-main-dark min-h-screen flex flex-col items-center justify-start p-4 sm:p-8 pt-[76px]">

    <div class="top-bar fixed top-0 left-0 right-0 z-50 h-[60px] flex items-center justify-between px-4 sm:px-6 shadow-md border-b backdrop-blur-sm bg-topbar-bg-light border-topbar-border-light dark:bg-topbar-bg-dark dark:border-topbar-border-dark">
        <div id="time-date-display" class="time-date">Loading...</div>
        <div class="top-bar-controls flex items-center space-x-2 sm:space-x-3">
             <a href="index.html" title="Homepage" class="top-bar-icon-btn"> <i class="fas fa-home text-sm"></i> </a>
             <a href="audiovisualizer.html" title="MP3 Player / Visualizer" class="top-bar-icon-btn"> <i class="fas fa-headphones text-sm"></i> </a>
             <a href="XboxGREPfdowngrader.html" title="Xbox Downgrader" class="top-bar-icon-btn"> <i class="fab fa-xbox text-sm"></i> </a>
             <a href="faceswapv1.html" title="Face Swap App" class="top-bar-icon-btn"> <i class="fas fa-face-smile text-sm"></i> </a>
             <button id="theme-toggle" aria-label="Toggle dark mode" class="top-bar-icon-btn">
                <svg id="theme-toggle-light-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-toggle-dark-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </div>

    <div class="main-panel p-6 sm:p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-4xl mt-4 mb-8 border border-border-light dark:border-border-dark bg-panel-light dark:bg-panel-dark">

        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-emerald-500 to-green-600 dark:from-emerald-400 dark:to-green-500 bg-clip-text text-transparent">
                Blackjack Deluxe V3
            </h1>
        </header>

        <main>
            <div class="game-area p-4 sm:p-6 rounded-lg border-4 border-game-border-light dark:border-game-border-dark mb-6 shadow-inner-light dark:shadow-inner-dark overflow-hidden">

                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-text-on-green mb-3 text-center tracking-wider uppercase">Dealer (<span id="dealer-score" class="font-mono font-bold">0</span>)</h2>
                    <div id="dealer-hand" class="hand-container min-h-[110px] p-3 flex flex-wrap gap-2 items-center justify-center rounded-lg">
                        <span class="text-sm italic text-white/70">Waiting for deal...</span>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-text-on-green mb-3 text-center tracking-wider uppercase">Player (<span id="player-score" class="font-mono font-bold">0</span>)</h2>
                    <div id="player-hand" class="hand-container min-h-[110px] p-3 flex flex-wrap gap-2 items-center justify-center rounded-lg">
                         <span class="text-sm italic text-white/70">Waiting for deal...</span>
                    </div>
                </div>

                <div id="message-area" class="text-center text-xl font-bold h-8 my-5 text-text-on-green [text-shadow:1px_1px_1px_rgba(0,0,0,0.6)] dark:[text-shadow:1px_1px_1px_rgba(0,0,0,0.8)]">
                    Click Deal to Start!
                </div>

                <div class="flex flex-wrap items-center justify-center gap-4 sm:gap-6 pt-4">
                    <button id="deal-button" class="game-button">Deal</button>
                    <button id="hit-button" class="game-button" disabled>Hit</button>
                    <button id="stand-button" class="game-button" disabled>Stand</button>
                    <button id="new-game-button" class="game-button">New Game</button>
                </div>

            </div>
        </main>

        <footer class="text-center mt-6 pt-4 border-t border-border-light dark:border-border-dark">
            <p class="text-xs opacity-70 text-text-secondary-light dark:text-text-secondary-dark">
                Enjoy the game! Please play responsibly.
            </p>
        </footer>

    </div>

    <script>
        // --- Theme Toggle Logic ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const htmlElement = document.documentElement;

        function applyTheme(theme) { /* ... same ... */
            const isDark = theme === 'dark';
            htmlElement.classList.toggle('dark', isDark);
            if (lightIcon && darkIcon) {
                darkIcon.style.display = isDark ? 'block' : 'none';
                lightIcon.style.display = isDark ? 'none' : 'block';
            }
            localStorage.setItem('theme', theme);
         }
        if (themeToggleButton) { themeToggleButton.addEventListener('click', () => { applyTheme(htmlElement.classList.contains('dark') ? 'light' : 'dark'); }); }
        function initializeTheme() { /* ... same ... */
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
         }

        // --- Live Time and Date Logic ---
        const timeDateDisplay = document.getElementById('time-date-display');
        const updateTimeDate = () => { /* ... same ... */
            if (timeDateDisplay) {
                const now = new Date();
                const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const optionsTime = { hour: 'numeric', minute: '2-digit' };
                const formattedDate = now.toLocaleDateString(undefined, optionsDate);
                const formattedTime = now.toLocaleTimeString(undefined, optionsTime);
                timeDateDisplay.textContent = `${formattedDate}, ${formattedTime}`;
            }
         };

        // --- Blackjack Game Logic V3 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateTimeDate();
            const timeInterval = setInterval(updateTimeDate, 1000 * 30);

            // Game Elements
            const dealButton = document.getElementById('deal-button');
            const hitButton = document.getElementById('hit-button');
            const standButton = document.getElementById('stand-button');
            const newGameButton = document.getElementById('new-game-button');
            const messageArea = document.getElementById('message-area');
            const dealerHandDiv = document.getElementById('dealer-hand');
            const playerHandDiv = document.getElementById('player-hand');
            const dealerScoreSpan = document.getElementById('dealer-score');
            const playerScoreSpan = document.getElementById('player-score');

            // Game State
            let deck = [];
            let dealerHand = [];
            let playerHand = [];
            let dealerScore = 0;
            let playerScore = 0;
            let gameInProgress = false;

            // Card Definitions
            const suits = { '♠': 'black', '♥': 'red', '♦': 'red', '♣': 'black' };
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const values = {'A': 11, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 10, 'Q': 10, 'K': 10};

            // --- Game Functions ---

            function createDeck() {
                deck = [];
                for (const suit in suits) {
                    for (const rank of ranks) {
                        deck.push({ suit, rank, value: values[rank], color: suits[suit] });
                    }
                }
             }

            function shuffleDeck() {
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
             }

            function dealCard(targetHand) {
                 if (deck.length < 4) { // Reshuffle if deck is low
                     createDeck();
                     shuffleDeck();
                     console.log("Deck reshuffled.");
                 }
                 const card = deck.pop();
                 targetHand.push(card);
                 return card;
             }

            function calculateScore(hand) {
                let score = 0; let aceCount = 0;
                for (const card of hand) { score += card.value; if (card.rank === 'A') aceCount++; }
                while (score > 21 && aceCount > 0) { score -= 10; aceCount--; }
                return score;
             }

            // Creates a card element, adds animation class
            function createCardElement(card, isHidden = false) {
                const cardDiv = document.createElement('div');
                // Apply base classes for styling
                cardDiv.className = `playing-card font-mono font-bold text-2xl min-w-[65px] min-h-[95px] border rounded-md p-2 m-1 shadow-card relative bg-card-bg-light border-card-border-light dark:bg-card-bg-dark dark:border-card-border-dark dark:shadow-card-dark inline-flex flex-col items-center justify-between hover:scale-103 hover:-translate-y-1 hover:shadow-lg`;

                if (isHidden) {
                    // Use solid color back defined in Tailwind config
                    cardDiv.classList.add('bg-card-back-light', 'dark:bg-card-back-dark', 'border-card-back-light', 'dark:border-card-back-dark');
                    cardDiv.innerHTML = `<span class="rank opacity-0">?</span><span class="suit opacity-0">?</span>`; // Placeholder for size
                } else {
                     const colorClass = card.color === 'red'
                        ? 'text-red-light dark:text-red-dark'
                        : 'text-black-light dark:text-black-dark';
                     cardDiv.classList.add(colorClass);
                     cardDiv.innerHTML = `<span class="rank text-3xl leading-tight">${card.rank}</span><span class="suit text-2xl leading-none">${card.suit}</span>`;
                }

                // Add animation class - will be applied by CSS defined in <style>
                cardDiv.classList.add('animate-deal-card');

                return cardDiv;
            }

             // Renders hands, applying animations via createCardElement
             function renderHands(hideDealerCard = true) {
                dealerHandDiv.innerHTML = ''; // Clear previous cards
                playerHandDiv.innerHTML = '';

                // Use setTimeout for slight stagger effect (optional)
                let playerDelay = 0;
                let dealerDelay = 0;

                // Render Player Hand
                playerHand.forEach(card => {
                    const cardElement = createCardElement(card);
                    // Apply animation delay if desired
                    // cardElement.style.animationDelay = `${playerDelay}ms`;
                    playerHandDiv.appendChild(cardElement);
                    playerDelay += 50; // Increment delay for next card
                });

                 // Render Dealer Hand
                 dealerHand.forEach((card, index) => {
                    const isHidden = hideDealerCard && index === 0;
                    const cardElement = createCardElement(card, isHidden);
                     // Apply animation delay if desired
                    // cardElement.style.animationDelay = `${dealerDelay}ms`;
                    dealerHandDiv.appendChild(cardElement);
                    dealerDelay += 50;
                });


                // Update Scores
                playerScore = calculateScore(playerHand);
                dealerScore = calculateScore(dealerHand);

                if (hideDealerCard && dealerHand.length > 0) {
                    const visibleCardValue = (dealerHand.length > 1 && dealerHand[1].value) ? dealerHand[1].value : 0;
                    dealerScoreSpan.textContent = `${visibleCardValue} + ?`;
                } else {
                    dealerScoreSpan.textContent = dealerScore;
                }
                playerScoreSpan.textContent = playerScore;
            }

            // Updates the message area with styling based on type
            function updateMessage(msg, type = 'info') {
                messageArea.textContent = msg;
                // Reset classes first
                messageArea.className = 'message-base'; // Assign a base class if needed, or reset manually
                 messageArea.classList.add(
                     'text-center', 'text-xl', 'font-bold', 'h-8', 'my-5', 'transition-colors', 'duration-300',
                     'text-text-on-green', '[text-shadow:1px_1px_1px_rgba(0,0,0,0.6)]', 'dark:[text-shadow:1px_1px_1px_rgba(0,0,0,0.8)]'
                 );

                // Add type-specific class for color/style
                 messageArea.classList.add(type); // 'win', 'lose', 'info', 'warn'
            }

            function disableGameButtons(disableDeal = true) {
                 if(dealButton && disableDeal) dealButton.disabled = true;
                 if(hitButton) hitButton.disabled = true;
                 if(standButton) standButton.disabled = true;
             }

             function enablePlayerButtons() {
                 if(hitButton) hitButton.disabled = false;
                 if(standButton) standButton.disabled = false;
             }

            function startGame() {
                createDeck(); shuffleDeck(); dealerHand = []; playerHand = []; gameInProgress = true;

                // Deal initial hands with slight delay for visual effect
                setTimeout(() => playerHand.push(dealCard(playerHand)), 0);
                setTimeout(() => dealCard(dealerHand), 100); // Hidden card dealt
                setTimeout(() => playerHand.push(dealCard(playerHand)), 200);
                setTimeout(() => dealCard(dealerHand), 300); // Visible card dealt

                // Render slightly after dealing starts
                setTimeout(() => {
                    renderHands(true);
                    updateMessage("Your turn: Hit or Stand?", "info");
                    enablePlayerButtons();
                    if(dealButton) dealButton.disabled = true;

                    // Check for immediate Blackjacks after rendering initial hands
                    if (playerScore === 21 && playerHand.length === 2) {
                        renderHands(false); // Reveal dealer's hand
                        if (dealerScore === 21 && dealerHand.length === 2) { updateMessage("Push! Both have Blackjack.", "info"); }
                        else { updateMessage("Blackjack! You win!", "win"); }
                        gameInProgress = false; disableGameButtons(false);
                    } else if (dealerScore === 21 && dealerHand.length === 2) {
                        renderHands(false); updateMessage("Dealer has Blackjack! Dealer wins.", "lose");
                        gameInProgress = false; disableGameButtons(false);
                    }
                }, 400); // Render after all cards conceptually dealt
            }


            function playerHit() {
                if (!gameInProgress) return;
                dealCard(playerHand);
                renderHands(true); // Re-render immediately

                if (playerScore > 21) {
                    updateMessage("Bust! Dealer wins.", "lose");
                    gameInProgress = false;
                    disableGameButtons(false);
                    renderHands(false);
                } else if (playerScore === 21) {
                    updateMessage("21! Press Stand.", "info");
                    if(hitButton) hitButton.disabled = true;
                }
            }

            function playerStand() {
                if (!gameInProgress) return;
                gameInProgress = false;
                disableGameButtons(false);
                renderHands(false); // Reveal dealer's hand immediately

                updateMessage("Dealer's turn...", "info");

                function dealerPlay() {
                    if (dealerScore < 17) {
                        updateMessage("Dealer hits...", "info");
                        dealCard(dealerHand);
                        renderHands(false);
                        if (dealerScore > 21) {
                            updateMessage("Dealer busts! You win!", "win");
                            // No need to call determineWinner here
                        } else {
                            setTimeout(dealerPlay, 800); // Continue dealer turn after delay
                        }
                    } else {
                        // Dealer stands (score >= 17 and <= 21)
                        determineWinner();
                    }
                }
                // Start dealer's turn after a short delay
                setTimeout(dealerPlay, 900); // Slightly longer delay
            }

            function determineWinner() {
                 renderHands(false); // Ensure dealer hand is revealed
                 if (playerScore > 21) { updateMessage("Bust! Dealer wins.", "lose"); }
                 else if (dealerScore > 21) { updateMessage("Dealer busts! You win!", "win"); }
                 else if (dealerScore > playerScore) { updateMessage("Dealer wins.", "lose"); }
                 else if (playerScore > dealerScore) { updateMessage("You win!", "win"); }
                 else { updateMessage("Push! (Tie)", "info"); }
                 gameInProgress = false;
                 disableGameButtons(false);
             }

             function resetUI() {
                 dealerHandDiv.innerHTML = `<span class="text-sm italic text-white/70">Waiting for deal...</span>`;
                 playerHandDiv.innerHTML = `<span class="text-sm italic text-white/70">Waiting for deal...</span>`;
                 dealerScoreSpan.textContent = '0'; playerScoreSpan.textContent = '0';
                 updateMessage('Click Deal to Start!', 'info');
                 disableGameButtons(true);
                 if(dealButton) dealButton.disabled = false;
                 gameInProgress = false;
             }

            // Event Listeners
            if (dealButton) dealButton.addEventListener('click', startGame);
            if (hitButton) hitButton.addEventListener('click', playerHit);
            if (standButton) standButton.addEventListener('click', playerStand);
            if (newGameButton) newGameButton.addEventListener('click', resetUI);

            // Initial UI state
             resetUI();

        }); // End DOMContentLoaded
    </script>

</body>
</html>
